name: Deploy to AWS

on:
  push:
    branches:
      - main
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies (test)
        run: npm ci

      - name: Deploy to AWS via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USERNAME }}
          key: ${{ secrets.AWS_SSH_KEY }}
          script: |
            # Check if directory exists
            if [ -d "${{ secrets.TARGET_DIR }}" ]; then
              echo "Directory exists. Pulling latest changes..."
              cd ${{ secrets.TARGET_DIR }}
              # Force Reset to ensure clean state (ignore local changes)
              git fetch --all
              git reset --hard origin/main
            else
              echo "Directory does not exist. Cloning repository..."
              git clone https://github.com/acsuthar2006-ctrl/Online-Tech-Hiring-Platform.git ${{ secrets.TARGET_DIR }}
              cd ${{ secrets.TARGET_DIR }}
            fi
            
            # Install dependencies
            npm install --production
            
            # Restart application
            # Check if pm2 process exists, if not start it, else restart
            if pm2 list | grep -q "Online-Tech-Hiring-Platform"; then
              pm2 restart Online-Tech-Hiring-Platform
            else
              # Start with announced IP from secret if available, or just default
              # Note: We don't have the IP secret here easily without passing it. 
              # For now, just start. User might need to configure IP manually once.
              pm2 start server.js --name Online-Tech-Hiring-Platform
            fi
